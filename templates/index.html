{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i data-feather="activity"></i>
            Мониторинг хостов
        </h1>
    </div>
</div>

{% if groups %}
<div class="row mb-4">
    <div class="col-md-6">
        <label for="group" class="form-label">Выберите группу:</label>
        <select id="group" class="form-select">
            {% for group in groups %}
                <option value="{{ group }}" {% if group == selected_group %}selected{% endif %}>{{ group }}</option>
            {% endfor %}
        </select>
    </div>
</div>

{% if selected_group %}
<!-- Вкладки подгрупп -->
{% if subgroups|length > 1 %}
<div class="subgroup-tabs mb-4">
    {% for subgroup in subgroups %}
        {% set status_class = subgroup_statuses.get(subgroup, {}).get('status', 'secondary') if subgroup != 'Все' else 'secondary' %}
        <a href="#" class="subgroup-tab status-{{ status_class }} {% if subgroup == selected_subgroup %}active{% endif %}" 
           data-subgroup="{{ subgroup }}">
            <span class="status-indicator status-{{ status_class }}"></span>
            {{ subgroup }}
            {% if subgroup != 'Все' and subgroup_statuses.get(subgroup) %}
                <small class="text-muted">
                    ({{ subgroup_statuses[subgroup]['up'] }}/{{ subgroup_statuses[subgroup]['total'] }})
                </small>
            {% endif %}
        </a>
    {% endfor %}
</div>
{% endif %}

<!-- Основные вкладки -->
<div class="border-b border-gray-200 mb-4">
    <nav class="nav nav-tabs">
        <a href="#hosts" class="nav-link tab-link" data-tab="hosts">
            <i data-feather="server"></i>
            Список хостов
        </a>
        <a href="#history" class="nav-link tab-link" data-tab="history">
            <i data-feather="clock"></i>
            История пингов
        </a>
        <a href="#dashboard" class="nav-link tab-link" data-tab="dashboard">
            <i data-feather="bar-chart-2"></i>
            Дашборд
        </a>
    </nav>
</div>

<!-- Вкладка: Список хостов -->
<div id="hosts" class="tab-content">
    <div class="dashboard-card">
        <h2 class="h4 mb-3">
            Список хостов в группе '{{ selected_group }}'
            {% if selected_subgroup != 'Все' %}
                / подгруппа '{{ selected_subgroup }}'
            {% endif %}
        </h2>
        
        {% if hosts %}
            <div class="table-responsive">
                <table class="table table-hover host-table">
                    <thead class="table-light">
                        <tr>
                            <th>Статус</th>
                            <th>Адрес</th>
                            <th>Описание</th>
                            <th>Подгруппа</th>
                            <th width="50">
                                <i data-feather="activity" title="Кликните по строке для перехода к логам"></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for host in hosts %}
                            {% set status_class = host_statuses.get(host.address, 'secondary') %}
                            <tr class="host-row status-{{ status_class }}" style="cursor: pointer;" title="Нажмите для просмотра логов">
                                <td>
                                    <span class="status-indicator status-{{ status_class }}"></span>
                                </td>
                                <td class="fw-bold">{{ host.address }}</td>
                                <td>{{ host.description }}</td>
                                <td>
                                    <span class="badge bg-secondary">{{ host.subgroup }}</span>
                                </td>
                                <td class="text-center">
                                    <i data-feather="arrow-right" class="text-muted"></i>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info">
                <i data-feather="info"></i>
                Список хостов пуст или группа не существует.
            </div>
        {% endif %}
    </div>
</div>

<!-- Вкладка: История пингов -->
<div id="history" class="tab-content">
    <div class="dashboard-card">
        <h2 class="h4 mb-3">История пингов</h2>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="host" class="form-label">Выберите хост:</label>
                <select id="host" class="form-select">
                    <option value="">-- Выберите хост --</option>
                    {% for host in hosts %}
                        <option value="{{ host.address }}" {% if host.address == selected_host %}selected{% endif %}>
                            {{ host.address }} ({{ host.description }})
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-3">
                <label for="start_time" class="form-label">Начало периода:</label>
                <input type="datetime-local" id="start_time" value="{{ start_time or '' }}" class="form-control">
            </div>
            <div class="col-md-3">
                <label for="end_time" class="form-label">Конец периода:</label>
                <input type="datetime-local" id="end_time" value="{{ end_time or '' }}" class="form-control">
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">Статус:</label>
                <select id="status" class="form-select">
                    <option value="">Все</option>
                    <option value="Доступен" {% if status == 'Доступен' %}selected{% endif %}>Доступен</option>
                    <option value="Недоступен" {% if status == 'Недоступен' %}selected{% endif %}>Недоступен</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-primary filter-history-btn w-100">
                    <i data-feather="filter"></i>
                    Фильтровать
                </button>
            </div>
        </div>
        
        {% if ping_history %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead class="table-light">
                        <tr>
                            <th>Время</th>
                            <th>Статус</th>
                            <th>Задержка</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in ping_history %}
                            <tr>
                                <td>{{ entry.timestamp }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if entry.status == 'Доступен' else 'danger' }}">
                                        {{ entry.status }}
                                    </span>
                                </td>
                                <td>{{ entry.latency }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info">
                <i data-feather="info"></i>
                История пингов пуста или хост не выбран.
            </div>
        {% endif %}
    </div>
</div>

<!-- Вкладка: Дашборд -->
<div id="dashboard" class="tab-content">
    <h2 class="h4 mb-4">
        Дашборд для группы '{{ selected_group }}'
        {% if selected_subgroup != 'Все' %}
            / подгруппа '{{ selected_subgroup }}'
        {% endif %}
    </h2>
    
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="dashboard-card">
                <h3 class="h5 mb-3">
                    <i data-feather="check-circle"></i>
                    Процент доступности хостов
                </h3>
                <div class="chart-container">
                    <canvas id="availabilityChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6 mb-4">
            <div class="dashboard-card">
                <h3 class="h5 mb-3">
                    <i data-feather="zap"></i>
                    Средняя задержка (сек)
                </h3>
                <div class="chart-container">
                    <canvas id="latencyChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-12 mb-4">
            <div class="dashboard-card">
                <h3 class="h5 mb-3">
                    <i data-feather="trending-down"></i>
                    Недоступные хосты по времени (последние 24 часа)
                </h3>
                <div class="chart-container">
                    <canvas id="downChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

{% endif %}
{% else %}
<div class="alert alert-warning">
    <i data-feather="alert-triangle"></i>
    <strong>Внимание:</strong> Не найдено групп хостов для мониторинга. Пожалуйста, настройте базу данных.
</div>
{% endif %}

<script>
// Передача данных дашборда в JavaScript
{% if dashboard_data %}
window.dashboardData = {{ dashboard_data | tojson }};
{% endif %}
</script>
{% endblock %}
